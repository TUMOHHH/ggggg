<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ALLRED • Tuner</title>

<!-- Inter -->
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700;800&display=swap" rel="stylesheet">

<style>
:root{--fg:#0a0a0a}
html,body{height:100%;margin:0;background:#f7f8fb}
.stage{position:relative;width:100%;height:100%;overflow:hidden;
  background:radial-gradient(120vmax 80vmax at 50% 40%, #fff 0%, #eef1f5 55%, #e9edf2 100%);
  font-family:"Inter",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--fg)}
#fx{position:absolute;inset:0;display:block;z-index:1}

/* Заголовок */
.ui{position:relative;z-index:2;width:100%;height:100%;display:grid;place-items:center;pointer-events:none}
.c{text-align:center;pointer-events:auto}
.t{font-weight:800;letter-spacing:-0.04em; /* ≈ –4% */
    font-size:clamp(28px,8vw,96px);line-height:.95}
.s{margin-top:.6rem;font-size:clamp(14px,2.4vw,24px);letter-spacing:-0.01em;opacity:.86}
.b{margin-top:1.1rem;display:inline-flex;gap:.6rem;align-items:center;padding:.85rem 1.15rem;border-radius:999px;
  border:1px solid #00000012;background:#111;color:#fff;font-weight:700;letter-spacing:.02em;cursor:pointer}

/* сетка + зерно */
.grid{position:absolute;inset:0;pointer-events:none;z-index:0;background:
  repeating-linear-gradient(to right,rgba(0,0,0,.06) 0,rgba(0,0,0,.06) 1px,transparent 60px),
  repeating-linear-gradient(to bottom,rgba(0,0,0,.04) 0,rgba(0,0,0,.04) 1px,transparent 60px);
  transform:perspective(1200px) rotateX(35deg) translateY(16vh);opacity:.45;filter:blur(.2px)}
.grain{position:absolute;inset:0;pointer-events:none;z-index:3;opacity:.1;mix-blend-mode:multiply;
  background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 80 80"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.8" numOctaves="2" stitchTiles="stitch"/></filter><rect width="100%" height="100%" filter="url(%23n)" opacity="0.9"/></svg>');
  animation:g 1.6s steps(2) infinite}
@keyframes g{0%{transform:translate(0,0)}25%{transform:translate(-8px,5px)}50%{transform:translate(7px,-4px)}75%{transform:translate(-3px,10px)}100%{transform:translate(0,0)}}

/* панель тюнера */
.panel{position:fixed;right:12px;top:12px;z-index:5;width:min(360px,92vw);
  background:#ffffffd9;border:1px solid #00000014;border-radius:14px;backdrop-filter:blur(8px);
  box-shadow:0 6px 28px #00000014}
.panel header{display:flex;align-items:center;justify-content:space-between;padding:.8rem 1rem;border-bottom:1px solid #00000010}
.panel header h3{margin:0;font-weight:800;letter-spacing:-0.02em;font-size:14px}
.panel .body{max-height:60vh;overflow:auto;padding:.75rem 1rem 1rem}
.row{display:grid;grid-template-columns:1fr auto;gap:.8rem;align-items:center;margin:.55rem 0}
.row label{font-size:12px;opacity:.78}
.row input[type=range]{width:210px}
.row input[type=color]{width:42px;height:28px;padding:0;border:none;background:transparent}
.actions{display:flex;gap:.5rem;justify-content:flex-end;margin-top:.6rem}
.actions button{border:1px solid #00000018;background:#111;color:#fff;border-radius:10px;padding:.5rem .8rem;font-weight:700;cursor:pointer}
.badge{position:fixed;right:10px;bottom:10px;z-index:9;font:600 11px/1 system-ui;padding:.25rem .5rem;border-radius:.5rem;background:#000c;color:#fff}
@media (max-width:820px){.ui{display:none}}
</style>
</head>
<body>
<div class="stage">
  <div class="grid"></div>
  <canvas id="fx"></canvas>
  <div class="ui">
    <div class="c">
      <div class="t">ALLRED Studio</div>
      <div class="s">We Make The Internet Better</div>
      <button class="b" id="cta">Leave a request</button>
    </div>
  </div>
  <div class="grain"></div>
</div>

<!-- панель тюнера -->
<div class="panel" id="panel">
  <header>
    <h3>ALLRED • Tuner</h3>
    <small id="live">live</small>
  </header>
  <div class="body">
    <div class="row"><label>Диагональ (0—1)</label><input id="diag"   type="range" min="0" max="1" step="0.01" value="0.65"></div>
    <div class="row"><label>Количество</label>      <input id="count"  type="range" min="30" max="300" step="1"    value="130"></div>
    <div class="row"><label>Размер min</label>      <input id="smin"   type="range" min="0.6" max="2.5" step="0.05" value="1.3"></div>
    <div class="row"><label>Размер max</label>      <input id="smax"   type="range" min="1.0" max="4.0" step="0.05" value="3.2"></div>
    <div class="row"><label>Hover сила</label>      <input id="hover"  type="range" min="0"   max="1"   step="0.01" value="0.28"></div>
    <div class="row"><label>Click сила</label>      <input id="click"  type="range" min="0"   max="2"   step="0.01" value="0.55"></div>
    <div class="row"><label>Радиус реакции</label>  <input id="radius" type="range" min="1"   max="6"   step="0.05" value="3.6"></div>
    <div class="row"><label>Скорость</label>        <input id="speed"  type="range" min="0.5" max="2"   step="0.01" value="1.0"></div>
    <div class="row"><label>Акцент (цвет)</label>   <input id="accent" type="color" value="#e10600"></div>
    <div class="actions">
      <button id="apply">Применить</button>
      <button id="reset" style="background:#444">Сброс</button>
      <button id="share" style="background:#0060ff">Ссылка</button>
    </div>
  </div>
</div>

<div class="badge">ALLRED tuner</div>

<!-- three.js -->
<script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
<script>
(() => {
  // ==== параметры (с URL-hash и localStorage) ====
  const defaults = {diag:.65,count:130,smin:1.3,smax:3.2,hover:.28,click:.55,radius:3.6,speed:1.0,accent:"#e10600"};
  const q = new URLSearchParams(location.hash.slice(1));
  const saved = JSON.parse(localStorage.getItem('allred-tuner')||'{}');
  const params = Object.assign({}, defaults, saved, Object.fromEntries(q.entries()));
  sanitizeParams(params);

  // ==== DOM ====
  const ui = {
    fx:fx, diag:diag, count:count, smin:smin, smax:smax, hover:hover, click:click, radius:radius, speed:speed, accent:accent,
    apply:apply, reset:reset, share:share
  };
  Object.entries({diag:'diag',count:'count',smin:'smin',smax:'smax',hover:'hover',click:'click',radius:'radius',speed:'speed',accent:'accent'})
    .forEach(([k,id])=> ui[id].value = params[k]);

  // ==== сцена ====
  let renderer, scene, camera, side, shards=[], center, cluster, debris=[];
  let env, nm, rm, redMat, glassMat;
  const BASE_W=1536, DAMP=.93;

  init();
  makeMaterials();
  spawnAll();
  animate(0);

  // ---------- init ----------
  function init(){
    renderer = new THREE.WebGLRenderer({canvas:ui.fx, antialias:true, alpha:true});
    renderer.setPixelRatio(Math.min(devicePixelRatio||1,2));
    renderer.setSize(innerWidth,innerHeight);

    scene = new THREE.Scene();
    scene.fog = new THREE.Fog(0xf1f5fb,22,60);

    camera = new THREE.PerspectiveCamera(55, innerWidth/innerHeight, .1, 150);
    camera.position.set(0,1.1,16); scene.add(camera);

    scene.add(new THREE.HemisphereLight(0xffffff,0xd6deea,1.0));
    const dir=new THREE.DirectionalLight(0xffffff,.95); dir.position.set(8,10,7); scene.add(dir);

    env = makeEnv();
    nm  = noise(256,256,.6,true); nm.wrapS=nm.wrapT=THREE.RepeatWrapping; nm.repeat.set(2,2);
    rm  = noise(256,256,.25,false);

    window.addEventListener('resize',onResize);
    onResize();
    setupInteraction();
  }

  function makeMaterials(){
    const normalScale=new THREE.Vector2(.15,.15);
    const RED = new THREE.Color(params.accent);

    glassMat = new THREE.MeshPhysicalMaterial({
      color:0xf8fbff, metalness:.35, roughness:.05,
      clearcoat:1, clearcoatRoughness:.025,
      transmission: renderer.capabilities.isWebGL2 ? 0.75 : 0.0, thickness:0.9, ior:1.45,
      envMap:env, envMapIntensity:1.3, normalMap:nm, roughnessMap:rm
    }); glassMat.normalScale = normalScale.clone();

    redMat = new THREE.MeshPhysicalMaterial({
      color:RED, metalness:.95, roughness:.22,
      clearcoat:1, clearcoatRoughness:.05,
      envMap:env, envMapIntensity:1.25, normalMap:nm, roughnessMap:rm
    }); redMat.normalScale = normalScale.clone();
  }

  function clearGroup(g){
    for(let i=g.children.length-1;i>=0;i--){
      const m=g.children[i]; if(m.geometry) m.geometry.dispose(); if(m.material) m.material.dispose();
      g.remove(m);
    }
  }

  function spawnAll(){
    clearGroup(side||new THREE.Group()); shards.length=0;
    clearGroup(cluster||new THREE.Group()); debris.length=0;

    // геометрии (только пирамиды)
    const geos=[
      new THREE.ConeGeometry(.6,1.35,3).translate(0,.675,0),
      new THREE.TetrahedronGeometry(.85,0),
      new THREE.ConeGeometry(.5,1.1,3).translate(0,.55,0)
    ];

    side = new THREE.Group(); scene.add(side);
    const scale = Math.min(1.5, Math.max(.7, innerWidth/BASE_W));
    const CNT = Math.max(10, Math.round(params.count*scale));
    const X=11,Y=7.2, diag=params.diag;

    for(let i=0;i<CNT;i++){
      const g=geos[(Math.random()*geos.length)|0];
      const mat=(Math.random()<.5? redMat: glassMat).clone();
      const m=new THREE.Mesh(g,mat);

      // диагональное распределение
      const x=THREE.MathUtils.randFloat(-X, X);
      const yRand=THREE.MathUtils.randFloat(-Y, Y);
      const yDiag=(Math.random()<.5?1:-1) * Math.abs(x) * diag + yRand*(1-diag);
      const base=new THREE.Vector3(x, yDiag, THREE.MathUtils.randFloat(-2.4,2.2));

      m.position.copy(base);
      m.rotation.set(Math.random()*Math.PI,Math.random()*Math.PI,Math.random()*Math.PI);
      m.scale.setScalar(THREE.MathUtils.randFloat(+params.smin, +params.smax));
      m.userData={ base:base.clone(), vel:new THREE.Vector3(
        THREE.MathUtils.randFloat(-.02,.02), THREE.MathUtils.randFloat(-.02,.02), THREE.MathUtils.randFloat(-.012,.012)
      )};
      side.add(m); shards.push(m);
    }

    // центральная фигура
    center = new THREE.Group(); scene.add(center); center.position.set(0,.2,0);
    cluster = new THREE.Group(); center.add(cluster);
    function pyr(r,h,isRed){ const g=new THREE.ConeGeometry(r,h,3).translate(0,h/2,0); return new THREE.Mesh(g,isRed?redMat.clone():glassMat.clone()); }
    const P=[], PD=[];
    const p1=pyr(1.2,2.25,false); p1.rotation.y=Math.PI/7; cluster.add(p1); P.push(p1);
    const p2=pyr(.9,1.85,true);   p2.position.set(1.65,.1,.2); p2.rotation.set(.05,-.42,.2); cluster.add(p2); P.push(p2);
    const p3=pyr(.78,1.65,false); p3.position.set(-1.52,-.15,-.3); p3.rotation.set(-.2,.5,-.15); cluster.add(p3); P.push(p3);
    const p4=pyr(.66,1.35,false); p4.position.set(.25,-.55,1.25); p4.rotation.set(.35,-.2,.1); cluster.add(p4); P.push(p4);
    const p5=pyr(.6,1.25,true);   p5.position.set(-.35,.78,.95);  p5.rotation.set(-.1,.25,0);  cluster.add(p5); P.push(p5);
    cluster.userData.pieces = P.map(m=>({m,base:m.position.clone(),rot:m.rotation.clone()}));

    // мелкий дебрис
    const dGeo=new THREE.TetrahedronGeometry(.1,0);
    const dMat=new THREE.MeshPhysicalMaterial({color:0xffffff,metalness:.6,roughness:.28,envMap:env,envMapIntensity:1.15,normalMap:nm,roughnessMap:rm});
    dMat.normalScale=new THREE.Vector2(.15,.15);
    const dGroup=new THREE.Group(); center.add(dGroup);
    for(let i=0;i<120;i++){
      const m=new THREE.Mesh(dGeo,(Math.random()<.3?redMat:dMat).clone());
      const rr=THREE.MathUtils.randFloat(1.6,3.0), a=Math.random()*Math.PI*2;
      m.position.set(Math.cos(a)*rr, THREE.MathUtils.randFloat(-.8,1.2), Math.sin(a)*rr);
      m.userData={base:m.position.clone(),ph:Math.random()*Math.PI*2};
      dGroup.add(m); debris.push(m);
    }
  }

  // интерактив
  const ray=new THREE.Raycaster(), ndc=new THREE.Vector2();
  const pointer=new THREE.Vector3(), planeZ0=new THREE.Plane(new THREE.Vector3(0,0,1),0);
  let active=false, hover=false;
  function setupInteraction(){
    addEventListener('pointermove',e=>{
      const rect=renderer.domElement.getBoundingClientRect();
      ndc.x=((e.clientX-rect.left)/rect.width)*2-1;
      ndc.y=-((e.clientY-rect.top)/rect.height)*2+1;
      ray.setFromCamera(ndc,camera);
      ray.ray.intersectPlane(planeZ0,pointer);
      active=true; hover = pointer.distanceTo(center.position) < 3.3;
    },{passive:true});
    addEventListener('pointerleave',()=>{active=false;hover=false});
    addEventListener('click',()=> impulse(+params.click, +params.radius*1.25));
  }
  function impulse(F,rad){
    for(const m of shards){
      const d=m.position.distanceTo(pointer);
      if(d<rad){ const dir=m.position.clone().sub(pointer).normalize(); m.userData.vel.addScaledVector(dir, F*(1-d/rad)); }
    }
  }

  // анимация
  function animate(t){
    requestAnimationFrame(animate);
    const sp=+params.speed;

    for(const m of shards){
      if(active){
        const d=m.position.distanceTo(pointer);
        if(d<+params.radius){
          const dir=m.position.clone().sub(pointer).normalize();
          m.userData.vel.addScaledVector(dir, +params.hover*(1-d/+params.radius));
        }
      }
      m.position.addScaledVector(m.userData.vel, sp);
      m.userData.vel.multiplyScalar(Math.pow(DAMP, sp));
      m.position.add(m.userData.base.clone().sub(m.position).multiplyScalar(0.02*sp));
      m.rotation.x+=m.userData.vel.y*0.7*sp; m.rotation.y+=m.userData.vel.x*0.7*sp;
    }

    cluster.rotation.y += 0.0026*sp;
    for(const d of debris){
      const p=d.userData.base.clone();
      p.x+=Math.sin(t*0.0016+d.userData.ph)*.12;
      p.y+=Math.cos(t*0.0013+d.userData.ph)*.10;
      d.position.lerp(p,.18);
      d.rotation.x+=.012*sp; d.rotation.y+=.01*sp;
    }
    for(const o of cluster.userData.pieces){
      const m=o.m;
      if(hover){
        const dir=m.position.clone().sub(cluster.position).normalize();
        const target=o.base.clone().addScaledVector(dir,.58);
        m.position.lerp(target,.24);
        m.rotation.x+=.012*sp; m.rotation.y+=.012*sp;
      }else{
        m.position.lerp(o.base,.14);
        m.rotation.x=THREE.MathUtils.lerp(m.rotation.x,o.rot.x,.14);
        m.rotation.y=THREE.MathUtils.lerp(m.rotation.y,o.rot.y,.14);
        m.rotation.z=THREE.MathUtils.lerp(m.rotation.z,o.rot.z,.14);
      }
    }
    renderer.render(scene,camera);
  }

  function onResize(){
    renderer.setSize(innerWidth,innerHeight);
    camera.aspect=innerWidth/innerHeight; camera.updateProjectionMatrix();
  }

  // helpers
  function makeEnv(){
    const faces=[]; for(let i=0;i<6;i++){ const c=document.createElement('canvas'); c.width=c.height=256;
      const x=c.getContext('2d'), g=x.createLinearGradient(0,0,256,256);
      if(i%2===0){ g.addColorStop(0,'#ffffff'); g.addColorStop(1,'#b9c7da'); }
      else{ g.addColorStop(0,'#f3f6fb'); g.addColorStop(.7,'#c9d4e4'); g.addColorStop(1, params.accent); }
      x.fillStyle=g; x.fillRect(0,0,256,256); faces.push(c);
    }
    const cube=new THREE.CubeTexture(faces); cube.needsUpdate=true; return cube;
  }
  function noise(w,h,inten,asNormal){
    const c=document.createElement('canvas'); c.width=w; c.height=h; const x=c.getContext('2d');
    const img=x.createImageData(w,h);
    for(let i=0;i<img.data.length;i+=4){
      const n=Math.random()*255;
      if(asNormal){ img.data[i]=128+(n-128)*.2; img.data[i+1]=128+(Math.random()*255-128)*.2; img.data[i+2]=255; img.data[i+3]=255; }
      else{ const v=255-n*inten; img.data[i]=img.data[i+1]=img.data[i+2]=v; img.data[i+3]=255; }
    }
    x.putImageData(img,0,0); return new THREE.CanvasTexture(c);
  }

  // UI
  ui.apply.onclick = () => {
    Object.assign(params, sanitizeParams({
      diag:+ui.diag.value,count:+ui.count.value,smin:+ui.smin.value,smax:+ui.smax.value,
      hover:+ui.hover.value,click:+ui.click.value,radius:+ui.radius.value,
      speed:+ui.speed.value,accent:ui.accent.value
    }));
    localStorage.setItem('allred-tuner', JSON.stringify(params));
    makeMaterials(); spawnAll();
  };
  ui.reset.onclick = () => {
    Object.assign(params, sanitizeParams({...defaults}));
    localStorage.removeItem('allred-tuner');
    Object.entries({diag:'diag',count:'count',smin:'smin',smax:'smax',hover:'hover',click:'click',radius:'radius',speed:'speed',accent:'accent'})
      .forEach(([k,id])=> ui[id].value = params[k]);
    makeMaterials(); spawnAll();
  };
  ui.share.onclick = async () => {
    const hash = new URLSearchParams(params).toString();
    const link = location.origin + location.pathname + '#' + hash;
    try{ await navigator.clipboard.writeText(link); ui.share.textContent='Скопировано'; setTimeout(()=>ui.share.textContent='Ссылка',1200) }catch(e){ alert(link) }
  };

  // страховка от «пустых» значений
  function sanitizeParams(p){
    p.count  = Math.max(10, Math.floor(+p.count||0));
    p.smin   = Math.max(0.2, +p.smin||1);
    p.smax   = Math.max(p.smin+0.1, +p.smax||p.smin+2);
    p.hover  = Math.max(0, +p.hover||0);
    p.click  = Math.max(0, +p.click||0);
    p.radius = Math.max(0.5, +p.radius||3);
    p.speed  = Math.max(0.1, +p.speed||1);
    p.diag   = Math.min(1, Math.max(0, +p.diag||0.65));
    if(!/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(p.accent||"")) p.accent="#e10600";
    return p;
  }

})();
</script>
</body>
</html>
